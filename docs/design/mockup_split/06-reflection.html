<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflection - AI Essay Training Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-hover': '#4a49c5',
                        'primary-light': '#ebebfa',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-primary mb-2 text-center">Final Reflection</h1>
            <p class="text-base md:text-lg text-gray-600 dark:text-gray-400 text-center">Goal 4: Do Your Own Writing and Editing</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Left Panel: Reflection (2 columns) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-primary">Reflect on Your Learning Journey</h2>

                    <!-- Goal 4 Explanation -->
                    <div class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                        <h3 class="font-bold text-green-900 dark:text-green-200 mb-2">Goal 4: Do Your Own Writing and Editing</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                            You maintained ownership of your work while using AI as a thinking partner. You made all final decisions and did the actual writing and editing yourself.
                        </p>
                    </div>

                    <!-- Reflection Prompts -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="text-xl">ðŸ’­</span>
                            Reflection Questions
                        </h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-900 dark:text-blue-200 mb-2">Context Provision (Goal 1)</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">How well did you provide context to the AI? What information was most helpful?</p>
                            </div>
                            <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-900 dark:text-purple-200 mb-2">Goal Negotiation (Goal 2)</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">How did you prioritize your revision goals? What strategic decisions did you make?</p>
                            </div>
                            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-900 dark:text-yellow-200 mb-2">Critical Review (Goal 3)</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">How did you evaluate AI suggestions? What questions did you ask?</p>
                            </div>
                            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-900 dark:text-green-200 mb-2">Independent Work (Goal 4)</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">How did you maintain ownership of your writing? What decisions did you make independently?</p>
                            </div>
                        </div>
                    </div>

                    <!-- Reflection Input -->
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500 mb-6">
                        <h3 class="font-bold text-blue-900 dark:text-blue-200 mb-3">Your Reflection</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">Reflect on your revision process, what you learned, what improved, and what challenges you faced:</p>
                        <textarea id="final-reflection" rows="8" placeholder="Write your reflection here..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary mb-2"></textarea>
                        <button id="submit-reflection" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            ðŸ’­ Submit Reflection
                        </button>
                    </div>

                    <!-- Skills Developed -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="text-xl">ðŸŽ¯</span>
                            Skills You Developed
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-900 dark:text-green-200 mb-2">AI Collaboration</h4>
                                <ul class="text-sm text-gray-700 dark:text-gray-300 space-y-1">
                                    <li>â€¢ Providing comprehensive context</li>
                                    <li>â€¢ Strategic goal setting</li>
                                    <li>â€¢ Critical evaluation of AI suggestions</li>
                                    <li>â€¢ Maintaining ownership of your work</li>
                                </ul>
                            </div>
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-900 dark:text-blue-200 mb-2">Writing Skills</h4>
                                <ul class="text-sm text-gray-700 dark:text-gray-300 space-y-1">
                                    <li>â€¢ Thesis statement development</li>
                                    <li>â€¢ Topic sentence creation</li>
                                    <li>â€¢ Paragraph development</li>
                                    <li>â€¢ Critical thinking in writing</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Completion Message -->
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                        <h3 class="font-bold text-green-900 dark:text-green-200 mb-2">âœ“ Training Complete!</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300">You've successfully worked through the essay revision process using AI as a thinking partner. You've practiced all four essential AI collaboration skills and maintained ownership of your writing throughout the process.</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Conversation (1 column) -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md sticky top-6">
                    <h3 class="text-lg md:text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ðŸ¤–</span>
                        AI Conversation
                    </h3>

                    <div id="chat-messages" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4 overflow-y-auto" style="height: 500px;">
                        <div class="text-center text-gray-500 dark:text-gray-400 text-sm py-12">
                            Your conversation with the AI will appear here. The AI will provide feedback on your reflection and learning journey.
                        </div>
                    </div>

                    <div id="loading-indicator" class="hidden text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        <p class="mt-2 text-xs text-gray-600 dark:text-gray-400">AI is thinking...</p>
                    </div>

                    <!-- General Chat Input -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <textarea id="general-chat-input" rows="3" placeholder="Ask the AI about your learning experience..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary mb-2"></textarea>
                        <button id="send-general-chat" class="w-full bg-primary hover:bg-primary-hover text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            Send Message
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.add(event.matches ? 'dark' : '');
            !event.matches && document.documentElement.classList.remove('dark');
        });

        // Custom modal function
        function showCustomModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border-2 border-primary">
                    <p class="text-gray-800 dark:text-gray-200 mb-4 text-base">${message}</p>
                    <button class="w-full px-4 py-2 bg-primary text-white hover:bg-primary-hover rounded-lg transition-colors font-semibold" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Reflection submission
        document.getElementById('submit-reflection').addEventListener('click', () => {
            const reflection = document.getElementById('final-reflection').value.trim();
            if (!reflection) { showCustomModal('Please write your reflection.'); return; }
            askAI(`@Claude-Sonnet-4.5 Student's reflection: "${reflection}"

Provide feedback on their metacognitive awareness and growth. Keep response under 5 sentences.`);
        });

        // General chat
        document.getElementById('send-general-chat').addEventListener('click', () => {
            const msg = document.getElementById('general-chat-input').value.trim();
            if (!msg) return;
            askAI(`@Claude-Sonnet-4.5 ${msg}`);
            document.getElementById('general-chat-input').value = '';
        });

        // AI Communication
        function addChatMessage(sender, content) {
            const chat = document.getElementById('chat-messages');
            const placeholder = chat.querySelector('.text-center.text-gray-500');
            if (placeholder) placeholder.remove();

            const msg = document.createElement('div');
            msg.className = 'mb-3';
            msg.innerHTML = `
                <div class="text-xs font-semibold mb-1 ${sender === 'You' ? 'text-gray-600 dark:text-gray-400' : 'text-primary'}">${sender === 'You' ? 'ðŸ‘¤' : 'ðŸ¤–'} ${sender}</div>
                <div class="p-3 rounded-lg text-sm ${sender === 'You' ? 'bg-gray-200 dark:bg-gray-600' : 'bg-blue-50 dark:bg-blue-900/30'}">${marked.parse(content)}</div>
            `;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateLastAIMessage(content) {
            const chat = document.getElementById('chat-messages');
            const messages = chat.querySelectorAll('.mb-3');
            if (messages.length > 0) {
                const last = messages[messages.length - 1];
                const contentDiv = last.querySelector('.p-3');
                if (contentDiv) {
                    contentDiv.innerHTML = marked.parse(content);
                    chat.scrollTop = chat.scrollHeight;
                }
            }
        }

        if (window.Poe) {
            window.Poe.registerHandler("essay-training", (result) => {
                const msg = result.responses[0];
                document.getElementById('loading-indicator').classList.add('hidden');

                if (msg.status === "error") {
                    addChatMessage("AI", `Error: ${msg.statusText}`);
                } else if (msg.status === "incomplete") {
                    if (msg.content.trim()) {
                        updateLastAIMessage(msg.content);
                    }
                } else if (msg.status === "complete") {
                    updateLastAIMessage(msg.content);
                }
            });
        }

        async function askAI(prompt) {
            if (!window.Poe) {
                showCustomModal("Poe API not available. This app needs to run in the Poe environment.");
                return;
            }

            // Extract user message from prompt
            const userMsg = prompt.split('\n').slice(1).join('\n').substring(0, 100) + '...';
            addChatMessage("You", userMsg);
            addChatMessage("AI", "...");
            document.getElementById('loading-indicator').classList.remove('hidden');

            try {
                await window.Poe.sendUserMessage(prompt, {
                    handler: "essay-training",
                    stream: true,
                    openChat: false
                });
            } catch (err) {
                document.getElementById('loading-indicator').classList.add('hidden');
                addChatMessage("AI", `Error: ${err.message}`);
            }
        }

        console.log('Reflection tab loaded');
    </script>
</body>
</html>
