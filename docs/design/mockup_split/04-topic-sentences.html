<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic Sentences - AI Essay Training Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-hover': '#4a49c5',
                        'primary-light': '#ebebfa',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sentence-highlight {
            cursor: pointer;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .sentence-highlight:hover {
            background-color: rgba(93, 92, 222, 0.2);
        }
        .sentence-selected {
            background-color: rgba(93, 92, 222, 0.3);
            border-bottom: 2px solid #5D5CDE;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-primary mb-2 text-center">Topic Sentences</h1>
            <p class="text-base md:text-lg text-gray-600 dark:text-gray-400 text-center">Focus on strengthening your topic sentences</p>
            
            <!-- Topic Sentence Progress Tracker -->
            <div class="mt-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg border border-green-200 dark:border-green-800">
                <h3 class="text-sm font-bold text-green-900 dark:text-green-200 mb-2">üìù Topic Sentence Development Progress</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                    <div class="flex items-center space-x-1">
                        <div id="progress-identify" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Identify sentences</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div id="progress-analyze" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Analyze connection</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div id="progress-revise" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Revise sentences</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div id="progress-improve" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Improve clarity</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Left Panel: Topic Sentences Work (2 columns) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Thesis Statement Display -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md">
                    <h2 class="text-xl font-bold mb-4 text-primary">Your Thesis Statement</h2>
                    
                    <div class="mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Original thesis:</p>
                        <p class="text-sm" id="original-thesis-display">I think individual actions not so important like what government and big companies do. But still, I kinda disagree because people also can do stuff to help.</p>
                    </div>

                    <div class="p-3 bg-green-100 dark:bg-green-800/30 rounded-lg border-l-4 border-green-500">
                        <p class="text-xs font-medium text-green-800 dark:text-green-200 mb-1">Revised thesis:</p>
                        <p class="text-sm font-medium text-green-900 dark:text-green-100" id="revised-thesis-display">I partially agree because while individual actions create collective impact through social movements, government policies have greater immediate effect on climate change.</p>
                    </div>
                </div>

                <!-- Student Body Paragraphs -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md">
                    <h2 class="text-xl font-bold mb-4 text-primary">Body Paragraphs</h2>

                    <div id="body-para-1" class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border-2 border-gray-300 dark:border-gray-600 mb-4">
                        <div class="text-xs md:text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">[Body Paragraph 1]</div>
                        <p class="text-sm md:text-base text-gray-800 dark:text-gray-200 leading-relaxed">
                            <span class="sentence-highlight topic-sent" data-topic="1">First, governments and companies, they got more power.</span> They can do big things. Like, government make laws for no pollution. They can stop plastic bags or tell factories to not make so much smoke. Companies also can change their ways. They can use less energy or make stuff that don't hurt environment. This is good because it change many people life at once. So powerful, you know.
                        </p>
                    </div>

                    <div id="body-para-2" class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border-2 border-gray-300 dark:border-gray-600">
                        <div class="text-xs md:text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">[Body Paragraph 2]</div>
                        <p class="text-sm md:text-base text-gray-800 dark:text-gray-200 leading-relaxed">
                            <span class="sentence-highlight topic-sent" data-topic="2">But individual actions, they matter too, I guess.</span> If many people do little things, it add up. Like, turn off lights at home save energy. Or buy things from green companies. Then companies think, oh, we must be green to sell more. But sometimes it hard to know if this really work. People don't always do it. Also, one person doing something. It not enough.
                        </p>
                    </div>
                </div>

                <!-- Topic Sentences Work -->
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md">
                    <h3 class="text-lg font-bold mb-4">Step 1: Locate Topic Sentences</h3>
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500 mb-4">
                        <p class="text-sm text-blue-900 dark:text-blue-200">
                            Click on the first sentence of each body paragraph (the topic sentence).
                        </p>
                    </div>
                    <div id="topic-selection" class="hidden space-y-2">
                        <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-xs font-medium text-gray-600 dark:text-gray-400">Topic Sentence 1:</p>
                            <p class="text-sm" id="selected-topic-1"></p>
                        </div>
                        <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <p class="text-xs font-medium text-gray-600 dark:text-gray-400">Topic Sentence 2:</p>
                            <p class="text-sm" id="selected-topic-2"></p>
                        </div>
                    </div>
                </div>

                <!-- Assessment -->
                <div id="topic-assessment" class="hidden bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md">
                    <h3 class="text-lg font-bold mb-4">Step 2: Assess Topic Sentences</h3>

                    <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-l-4 border-purple-500">
                        <label class="block text-sm font-bold mb-2 text-purple-900 dark:text-purple-200">
                            Do your topic sentences echo and support the points in your thesis?
                        </label>
                        <div class="mb-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                            <p class="text-xs font-medium text-blue-800 dark:text-blue-200 mb-1">üí° Reference your thesis statement above</p>
                            <p class="text-xs text-blue-700 dark:text-blue-300 mb-2">Look at both your original and revised thesis statements to see which points your topic sentences should support.</p>
                            <div class="p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded border border-yellow-300 dark:border-yellow-700">
                                <p class="text-xs font-medium text-yellow-800 dark:text-yellow-200 mb-1">üéØ Critical Thinking Tip:</p>
                                <p class="text-xs text-yellow-700 dark:text-yellow-300">Ask the AI: "Can you show me specific examples of how to connect my topic sentences to my thesis points?" or "What makes a topic sentence effective?"</p>
                            </div>
                        </div>
                        <textarea id="assess-topic-connection" rows="4" placeholder="Explain how each topic sentence connects to a thesis point..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary mb-2"></textarea>
                        <button id="ask-topic-assessment" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                            üí¨ Ask AI for Feedback
                        </button>
                    </div>
                </div>

                <!-- Revision -->
                <div id="topic-revision" class="hidden bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md">
                    <h3 class="text-lg font-bold mb-4">Step 3: Revise Topic Sentences</h3>

                    <!-- AI Guidance Section -->
                    <div class="mb-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                        <h4 class="text-sm font-bold text-green-900 dark:text-green-200 mb-2">ü§ñ AI Guidance for Topic Sentence Revision</h4>
                        <div class="text-xs text-green-800 dark:text-green-300 space-y-1">
                            <p><strong>Ask the AI for specific help:</strong></p>
                            <ul class="ml-4 space-y-1">
                                <li>‚Ä¢ "Can you show me examples of strong topic sentences that connect to thesis points?"</li>
                                <li>‚Ä¢ "How can I make my topic sentence more specific and clear?"</li>
                                <li>‚Ä¢ "What transition words should I use to connect to my thesis?"</li>
                                <li>‚Ä¢ "Can you explain why this topic sentence works better than my original?"</li>
                            </ul>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border-l-4 border-orange-500">
                            <label class="block text-sm font-bold mb-2 text-orange-900 dark:text-orange-200">
                                Body Paragraph 1 - Revised Topic Sentence:
                            </label>
                            <div class="mb-2 p-2 bg-orange-100 dark:bg-orange-800/30 rounded text-xs">
                                <strong>üí° Tip:</strong> Make sure this sentence directly supports one point from your revised thesis statement above.
                            </div>
                            <textarea id="revised-topic-1" rows="2" placeholder="Write improved topic sentence that echoes a thesis point..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary"></textarea>
                        </div>

                        <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border-l-4 border-orange-500">
                            <label class="block text-sm font-bold mb-2 text-orange-900 dark:text-orange-200">
                                Body Paragraph 2 - Revised Topic Sentence:
                            </label>
                            <div class="mb-2 p-2 bg-orange-100 dark:bg-orange-800/30 rounded text-xs">
                                <strong>üí° Tip:</strong> This sentence should support a different point from your thesis statement.
                            </div>
                            <textarea id="revised-topic-2" rows="2" placeholder="Write improved topic sentence that echoes a thesis point..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary mb-2"></textarea>
                            <button id="ask-topic-revision" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                                ‚úèÔ∏è Ask AI to Review Revisions
                            </button>
                        </div>

                        <!-- Critical Review Embedded -->
                        <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-500">
                            <h4 class="font-bold text-yellow-900 dark:text-yellow-200 mb-2">üí° Critical Thinking (Goal 3)</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">Question the AI's suggestions and ask for explanations:</p>
                            
                            <!-- Example Critical Questions -->
                            <div class="mb-3 p-3 bg-yellow-100 dark:bg-yellow-800/30 rounded-lg">
                                <p class="text-xs font-medium text-yellow-800 dark:text-yellow-200 mb-2">üìö Example Critical Questions:</p>
                                <div class="text-xs text-yellow-700 dark:text-yellow-300 space-y-1">
                                    <p><strong>Request examples:</strong> "Can you show me examples of strong topic sentences that connect to thesis points?"</p>
                                    <p><strong>Seek clarification:</strong> "Why is this approach better? What specific elements make it effective?"</p>
                                    <p><strong>Challenge AI reasoning:</strong> "What evidence supports this suggestion? How do you know this works?"</p>
                                    <p><strong>Request alternatives:</strong> "What other ways could I structure this topic sentence? What are the trade-offs?"</p>
                                </div>
                            </div>
                            
                            <textarea id="critical-topic-question" rows="2" placeholder="Ask the AI to explain their reasoning or provide examples..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary mb-2"></textarea>
                            <button id="ask-critical-topic" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                                ‚ùì Ask Critical Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Tutoring & Comments (1 column) -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md sticky top-6">
                    <h3 class="text-lg md:text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üë®‚Äçüè´</span>
                        AI Tutor Comments
                    </h3>

                    <!-- Progress Tracking -->
                    <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                        <h4 class="text-sm font-bold text-green-900 dark:text-green-200 mb-2">üìà Your Progress</h4>
                        <div class="text-xs text-green-800 dark:text-green-300 space-y-1">
                            <p><strong>Current Step:</strong> Topic Sentence Analysis</p>
                            <p><strong>Focus:</strong> Connecting sentences to thesis points</p>
                            <p><strong>Next:</strong> Revise based on AI feedback</p>
                        </div>
                    </div>

                    <!-- AI Tutor Feedback -->
                    <div id="tutor-feedback" class="mb-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border-l-4 border-blue-500">
                            <h4 class="text-sm font-bold text-blue-900 dark:text-blue-200 mb-2">ü§ñ AI Tutor Analysis</h4>
                            <div id="tutor-messages" class="text-sm text-blue-800 dark:text-blue-300">
                                <div class="text-center text-gray-500 dark:text-gray-400 text-xs py-4">
                                    AI tutor feedback will appear here after you submit your analysis.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Teaching Points -->
                    <div class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-500">
                        <h4 class="text-sm font-bold text-yellow-900 dark:text-yellow-200 mb-2">üí° Key Teaching Points</h4>
                        <div class="text-xs text-yellow-800 dark:text-yellow-300 space-y-1">
                            <p><strong>Topic sentences should:</strong></p>
                            <ul class="ml-3 space-y-1">
                                <li>‚Ä¢ Directly support a thesis point</li>
                                <li>‚Ä¢ Be specific and clear</li>
                                <li>‚Ä¢ Preview paragraph content</li>
                                <li>‚Ä¢ Use transition words</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Clarification Reminders -->
                    <div class="mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-l-4 border-purple-500">
                        <h4 class="text-sm font-bold text-purple-900 dark:text-purple-200 mb-2">‚ùì Ask for Clarification</h4>
                        <div class="text-xs text-purple-800 dark:text-purple-300 space-y-1">
                            <p><strong>Don't just accept AI suggestions!</strong></p>
                            <p>Ask: "Can you show me examples?" or "Why is this better?"</p>
                        </div>
                    </div>

                    <div id="loading-indicator" class="hidden text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        <p class="mt-2 text-xs text-gray-600 dark:text-gray-400">AI tutor is analyzing...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.add(event.matches ? 'dark' : '');
            !event.matches && document.documentElement.classList.remove('dark');
        });

        // State
        const state = {
            selectedTopics: { 1: '', 2: '' },
            originalThesis: 'I think individual actions not so important like what government and big companies do. But still, I kinda disagree because people also can do stuff to help.',
            revisedThesis: 'I partially agree because while individual actions create collective impact through social movements, government policies have greater immediate effect on climate change.',
            topicSentenceProgress: {
                identify: false,
                analyze: false,
                revise: false,
                improve: false
            }
        };

        // Progress tracking functions
        function updateProgress(step) {
            state.topicSentenceProgress[step] = true;
            const indicator = document.getElementById(`progress-${step}`);
            if (indicator) {
                indicator.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                indicator.classList.add('bg-green-500');
            }
            
            // Show immediate progress feedback
            showProgressFeedback(step);
            
            // Update AI tutor feedback based on progress
            setTimeout(() => {
                updateTutorFeedbackBasedOnProgress();
            }, 2000);
        }

        // Immediate progress feedback
        function showProgressFeedback(step) {
            const stepNames = {
                'identify': 'Identifying Topic Sentences',
                'analyze': 'Analyzing Connections',
                'revise': 'Revising Sentences',
                'improve': 'Improving Clarity'
            };
            
            const stepName = stepNames[step] || step;
            const completedSteps = Object.values(state.topicSentenceProgress).filter(Boolean).length;
            
            let feedback = '';
            if (completedSteps === 1) {
                feedback = `üéâ Great start! You've demonstrated ${stepName} - that's exactly what topic sentence development looks like!`;
            } else if (completedSteps === 2) {
                feedback = `üéâ Excellent! You're building strong topic sentence skills with ${stepName}. Keep it up!`;
            } else if (completedSteps === 3) {
                feedback = `üéâ Outstanding! You're almost there with ${stepName}. One more skill to go!`;
            } else if (completedSteps === 4) {
                feedback = `üéâ PERFECT! You've mastered all topic sentence development skills including ${stepName}!`;
            }
            
            if (feedback) {
                addTutorComment(feedback, 'progress');
            }
        }

        // Real-time AI tutor feedback based on progress
        function updateTutorFeedbackBasedOnProgress() {
            const { identify, analyze, revise, improve } = state.topicSentenceProgress;
            const completedSteps = [identify, analyze, revise, improve].filter(Boolean).length;
            
            let progressComment = '';
            
            if (completedSteps === 0) {
                progressComment = `**üéØ AI Tutor Progress Update**

Welcome! I'm here to help you develop strong topic sentence skills.

**Current Status:** You're just getting started - that's perfect! 

**What I'm looking for:**
- Identifying topic sentences in your paragraphs
- Analyzing how they connect to your thesis
- Revising sentences for better clarity
- Improving overall sentence structure

**Next Step:** Start by clicking on the topic sentences in your body paragraphs. I'll help you analyze their connection to your thesis!`;
            } else if (completedSteps === 1) {
                progressComment = `**üéØ AI Tutor Progress Update**

Great start! You've begun working on topic sentence development.

**Current Status:** 1/4 topic sentence skills demonstrated ‚úÖ

**What you've done well:**
- Started identifying or analyzing topic sentences

**What I'm looking for next:**
- Continue analyzing connections to your thesis
- Revise sentences for better clarity
- Improve overall sentence structure

**Next Step:** Keep working on your topic sentences! Ask me "How do these connect to my thesis?" or "How can I improve these sentences?"`;
            } else if (completedSteps === 2) {
                progressComment = `**üéØ AI Tutor Progress Update**

Excellent progress! You're developing strong topic sentence skills.

**Current Status:** 2/4 topic sentence skills demonstrated ‚úÖ‚úÖ

**What you've done well:**
- Identifying and analyzing topic sentences
- Starting to revise or improve sentences

**What I'm looking for next:**
- Continue revising sentences for better clarity
- Improve overall sentence structure
- Ensure strong connections to your thesis

**Next Step:** Try asking "How can I make these sentences clearer?" or "How do I strengthen the connection to my thesis?"`;
            } else if (completedSteps === 3) {
                progressComment = `**üéØ AI Tutor Progress Update**

Outstanding! You're demonstrating sophisticated topic sentence development.

**Current Status:** 3/4 topic sentence skills demonstrated ‚úÖ‚úÖ‚úÖ

**What you've done well:**
- Identifying and analyzing topic sentences
- Revising sentences for better clarity
- Improving sentence structure

**What I'm looking for next:**
- One more skill to demonstrate complete topic sentence development
- Continue improving clarity and connections
- Finalize your topic sentence revisions

**Next Step:** You're almost there! Keep improving your topic sentences - you're doing excellent work!`;
            } else if (completedSteps === 4) {
                progressComment = `**üéØ AI Tutor Progress Update**

üéâ **PERFECT!** You've demonstrated all aspects of topic sentence development!

**Current Status:** 4/4 topic sentence skills demonstrated ‚úÖ‚úÖ‚úÖ‚úÖ

**What you've accomplished:**
- ‚úÖ Identified topic sentences in your paragraphs
- ‚úÖ Analyzed connections to your thesis
- ‚úÖ Revised sentences for better clarity
- ‚úÖ Improved overall sentence structure

**This is exactly what strong topic sentence development looks like!** You're now creating clear, well-connected topic sentences that support your thesis effectively.

**Keep it up!** Continue applying these skills as you develop your essay paragraphs.`;
            }
            
            // Update the tutor feedback with progress-based comment
            if (progressComment) {
                updateTutorFeedback(progressComment);
            }
        }

        // Topic Sentences: Locate
        document.querySelectorAll('.topic-sent').forEach(sent => {
            sent.addEventListener('click', () => {
                sent.classList.toggle('sentence-selected');
                const topicNum = sent.getAttribute('data-topic');
                state.selectedTopics[topicNum] = sent.classList.contains('sentence-selected') ? sent.textContent.trim() : '';
                document.getElementById(`selected-topic-${topicNum}`).textContent = state.selectedTopics[topicNum];

                if (state.selectedTopics[1] && state.selectedTopics[2]) {
                    document.getElementById('topic-selection').classList.remove('hidden');
                    document.getElementById('topic-assessment').classList.remove('hidden');
                    
                    // Track progress - identifying topic sentences
                    if (!state.topicSentenceProgress.identify) {
                        updateProgress('identify');
                    }
                }
            });
        });

        // Custom modal function
        function showCustomModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border-2 border-primary">
                    <p class="text-gray-800 dark:text-gray-200 mb-4 text-base">${message}</p>
                    <button class="w-full px-4 py-2 bg-primary text-white hover:bg-primary-hover rounded-lg transition-colors font-semibold" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        document.getElementById('ask-topic-assessment').addEventListener('click', () => {
            const input = document.getElementById('assess-topic-connection').value.trim();
            if (!input) { showCustomModal('Please explain the connection first.'); return; }
            
            // Track progress - analyzing connections
            if (!state.topicSentenceProgress.analyze) {
                updateProgress('analyze');
            }
            
            askAI(`@Claude-Sonnet-4.5 Original thesis: "${state.originalThesis}"
Revised thesis: "${state.revisedThesis}"
Topic 1: "${state.selectedTopics[1]}"
Topic 2: "${state.selectedTopics[2]}"
Student's analysis: "${input}"

DIRECTLY answer: Do these topic sentences echo thesis points? Provide specific feedback, examples, and concrete suggestions for improvement. Then remind the student to ask for clarification: "Can you show me examples of strong topic sentences?" or "Why is this approach better?" Keep response under 5 sentences.`);
            document.getElementById('topic-revision').classList.remove('hidden');
        });

        document.getElementById('ask-topic-revision').addEventListener('click', () => {
            const t1 = document.getElementById('revised-topic-1').value.trim();
            const t2 = document.getElementById('revised-topic-2').value.trim();
            if (!t1 || !t2) { showCustomModal('Please revise both topic sentences.'); return; }
            
            // Track progress - revising sentences
            if (!state.topicSentenceProgress.revise) {
                updateProgress('revise');
            }
            askAI(`@Claude-Sonnet-4.5 Revised topic sentences:
1: "${t1}"
2: "${t2}"

Do these clearly connect to thesis points? Provide specific feedback and examples. Encourage the student to ask: "Can you show me examples of effective topic sentences?" or "What makes this approach better?" Provide feedback in 4-5 sentences.`);
        });

        document.getElementById('ask-critical-topic').addEventListener('click', () => {
            const q = document.getElementById('critical-topic-question').value.trim();
            if (!q) { showCustomModal('Please ask a question.'); return; }
            askAI(`@Claude-Sonnet-4.5 Student question about topic sentences: "${q}"

Provide detailed explanation with examples and evidence. Encourage further questions like: "Can you show me more examples?" or "What are the limitations of this approach?" Keep response under 5 sentences.`);
        });

        // Note: General chat functionality removed - using tutor feedback system instead

        // AI Tutor Feedback System
        function updateTutorFeedback(content) {
            const tutorMessages = document.getElementById('tutor-messages');
            const placeholder = tutorMessages.querySelector('.text-center.text-gray-500');
            if (placeholder) placeholder.remove();

            tutorMessages.innerHTML = marked.parse(content);
        }

        function addTutorComment(content, type = 'analysis') {
            const tutorMessages = document.getElementById('tutor-messages');
            const placeholder = tutorMessages.querySelector('.text-center.text-gray-500');
            if (placeholder) placeholder.remove();

            const comment = document.createElement('div');
            comment.className = `mb-3 p-3 rounded-lg ${type === 'analysis' ? 'bg-blue-50 dark:bg-blue-900/30' : 'bg-green-50 dark:bg-green-900/30'}`;
            comment.innerHTML = marked.parse(content);
            tutorMessages.appendChild(comment);
        }

        if (window.Poe) {
            window.Poe.registerHandler("essay-training", (result) => {
                const msg = result.responses[0];
                document.getElementById('loading-indicator').classList.add('hidden');

                if (msg.status === "error") {
                    updateTutorFeedback(`**Error:** ${msg.statusText}`);
                } else if (msg.status === "incomplete") {
                    if (msg.content.trim()) {
                        updateTutorFeedback(msg.content);
                    }
                } else if (msg.status === "complete") {
                    updateTutorFeedback(msg.content);
                }
            });
        }

        async function askAI(prompt) {
            if (!window.Poe) {
                showCustomModal("Poe API not available. This app needs to run in the Poe environment.");
                return;
            }

            document.getElementById('loading-indicator').classList.remove('hidden');

            try {
                await window.Poe.sendUserMessage(prompt, {
                    handler: "essay-training",
                    stream: true,
                    openChat: false
                });
            } catch (err) {
                document.getElementById('loading-indicator').classList.add('hidden');
                updateTutorFeedback(`**Error:** ${err.message}`);
            }
        }

        // Initialize with progress-based feedback
        updateTutorFeedbackBasedOnProgress();
        
        console.log('Topic Sentences tab loaded');
    </script>
</body>
</html>
