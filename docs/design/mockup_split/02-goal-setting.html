<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Setting - AI Essay Training Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-hover': '#4a49c5',
                        'primary-light': '#ebebfa',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-primary mb-2 text-center">Goal Setting</h1>
            <p class="text-base md:text-lg text-gray-600 dark:text-gray-400 text-center">Goal 2: Negotiate with AI on Agenda and Goals</p>
            
            <!-- Goal 2 Progress Tracker -->
            <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <h3 class="text-sm font-bold text-blue-900 dark:text-blue-200 mb-2">üéØ Goal 2: Strategic Planning Progress</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                    <div class="flex items-center space-x-1">
                        <div id="progress-prioritize" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Set priorities</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div id="progress-negotiate" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Negotiate goals</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div id="progress-constraints" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Consider constraints</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div id="progress-strategy" class="w-3 h-3 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                        <span class="text-gray-600 dark:text-gray-400">Develop strategy</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Left Panel: Goal Setting (2 columns) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md">
                    <h2 class="text-xl md:text-2xl font-bold mb-4 text-primary">Your Revision Goals</h2>

                    <!-- Goal 2 Explanation -->
                    <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                        <h3 class="font-bold text-blue-900 dark:text-blue-200 mb-2">Goal 2: Negotiate with AI on Agenda and Goals</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                            Learn to strategically plan your revision by setting priorities, considering time constraints, and focusing on macro-level issues first.
                        </p>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg border border-yellow-300 dark:border-yellow-700">
                            <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
                                <span class="font-bold">üéØ Priority Focus:</span> Some goals are essential (thesis & topic sentences), while others offer flexibility (body paragraphs). Use the AI chatbot to explore your options!
                            </p>
                        </div>
                    </div>

                    <!-- AI-Suggested Goals -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="text-xl">üéØ</span>
                            AI-Suggested Goals Based on Your Essay
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">The AI has analyzed your essay and suggests these focus areas:</p>

                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border-2 border-gray-300 dark:border-gray-600">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-2">Suggested Revision Goals:</h4>
                            <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <li>‚Ä¢ <strong>Improve thesis statement clarity</strong> - Ensure it directly answers the question and includes 2 specific points</li>
                                <li>‚Ä¢ <strong>Strengthen topic sentences</strong> - Make them echo and support thesis points</li>
                                <li>‚Ä¢ <strong>Enhance body paragraph development</strong> - Focus on one paragraph to improve detail and coherence</li>
                                <li>‚Ä¢ <strong>Address grammar and sentence structure</strong> - Improve clarity and flow</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Student Goal Selection -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="text-xl">‚úèÔ∏è</span>
                            Select Your Priority Goals
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Choose what you want to focus on in this session:</p>

                        <!-- Required Goals Section -->
                        <div class="mb-4">
                            <h4 class="text-md font-bold mb-3 flex items-center gap-2 text-red-700 dark:text-red-400">
                                <span class="text-lg">üî¥</span>
                                Essential Goals (Required)
                            </h4>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">These are fundamental to your essay structure and must be addressed:</p>
                            
                            <div class="space-y-3">
                                <label class="flex items-start gap-3 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/30 border border-red-200 dark:border-red-800">
                                    <input type="checkbox" class="goal-checkbox mt-1" value="thesis" checked disabled>
                                    <div class="flex-1">
                                        <p class="font-medium text-red-800 dark:text-red-200">Improve thesis statement clarity</p>
                                        <p class="text-sm text-red-600 dark:text-red-400">Ensure it answers the question and includes 2 specific points</p>
                                        <span class="inline-block mt-1 px-2 py-1 bg-red-200 dark:bg-red-800 text-red-800 dark:text-red-200 text-xs rounded-full">Required</span>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/30 border border-red-200 dark:border-red-800">
                                    <input type="checkbox" class="goal-checkbox mt-1" value="topic-sentences" checked disabled>
                                    <div class="flex-1">
                                        <p class="font-medium text-red-800 dark:text-red-200">Strengthen topic sentences</p>
                                        <p class="text-sm text-red-600 dark:text-red-400">Make them echo and support thesis points</p>
                                        <span class="inline-block mt-1 px-2 py-1 bg-red-200 dark:bg-red-800 text-red-800 dark:text-red-200 text-xs rounded-full">Required</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Flexible Goals Section -->
                        <div class="mb-4">
                            <h4 class="text-md font-bold mb-3 flex items-center gap-2 text-green-700 dark:text-green-400">
                                <span class="text-lg">üü¢</span>
                                Flexible Goals (Your Choice)
                            </h4>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Choose based on your essay's needs and time available:</p>
                            
                            <div class="space-y-3">
                                <label class="flex items-start gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-800">
                                    <input type="checkbox" class="goal-checkbox mt-1" value="paragraph-development" checked>
                                    <div class="flex-1">
                                        <p class="font-medium text-green-800 dark:text-green-200">Enhance body paragraph development</p>
                                        <p class="text-sm text-green-600 dark:text-green-400">Focus on one paragraph to improve detail and coherence</p>
                                        <span class="inline-block mt-1 px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 text-xs rounded-full">Flexible</span>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-800">
                                    <input type="checkbox" class="goal-checkbox mt-1" value="grammar-vocabulary">
                                    <div class="flex-1">
                                        <p class="font-medium text-green-800 dark:text-green-200">Address grammar and vocabulary</p>
                                        <p class="text-sm text-green-600 dark:text-green-400">Improve sentence structure and word choice</p>
                                        <span class="inline-block mt-1 px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 text-xs rounded-full">Flexible</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-2">Add custom goals (optional):</label>
                            <textarea id="custom-goals" rows="2" placeholder="E.g., Improve vocabulary variety, fix specific grammar issues..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary"></textarea>
                        </div>
                    </div>

                    <!-- Strategic Planning -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="text-xl">üìã</span>
                            Strategic Planning
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-900 dark:text-green-200 mb-2">Macro-Level Issues (Priority 1)</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300">Content, organization, thesis, topic sentences</p>
                            </div>
                            <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg border-l-4 border-orange-500">
                                <h4 class="font-bold text-orange-900 dark:text-orange-200 mb-2">Micro-Level Issues (Priority 2)</h4>
                                <p class="text-sm text-gray-700 dark:text-gray-300">Grammar, vocabulary, sentence structure</p>
                            </div>
                        </div>
                    </div>

                    <!-- Time Constraints -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="text-xl">‚è∞</span>
                            Time Management
                        </h3>
                        <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-l-4 border-purple-500">
                            <div class="mb-3">
                                <label class="block text-sm font-bold mb-2 text-purple-900 dark:text-purple-200">
                                    How much time do you have for this session?
                                </label>
                                <p class="text-xs text-purple-700 dark:text-purple-300 mb-2">
                                    <span class="font-semibold">Recommended:</span> 15-20 minutes for focused revision
                                </p>
                            </div>
                            <select id="time-constraint" class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary">
                                <option value="15min">15 minutes (Quick focus)</option>
                                <option value="20min" selected>20 minutes (Recommended)</option>
                                <option value="30min">30 minutes</option>
                                <option value="45min">45 minutes</option>
                                <option value="60min">1 hour</option>
                            </select>
                            <div class="mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded border border-yellow-300 dark:border-yellow-700">
                                <p class="text-xs text-yellow-800 dark:text-yellow-200">
                                    <span class="font-semibold">üí° Tip:</span> Shorter sessions (15-20 min) help maintain focus on essential goals. Use the AI chatbot to explore options efficiently!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Goals Summary -->
                    <div id="selected-goals-summary" class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500">
                        <h4 class="font-bold text-green-900 dark:text-green-200 mb-2">Your Selected Goals:</h4>
                        <div id="goals-list" class="text-sm text-gray-700 dark:text-gray-300"></div>
                    </div>

                    <!-- Confirmation Button -->
                    <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                        <button id="confirm-goals" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors text-lg">
                            ‚úì Confirm Goals and Proceed
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Conversation (1 column) -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 md:p-6 shadow-md sticky top-6">
                    <h3 class="text-lg md:text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ü§ñ</span>
                        AI Tutor Feedback
                    </h3>

                    <!-- Progress Status -->
                    <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                        <p><strong>Current Step:</strong> Goal Setting and Strategic Planning</p>
                        <p><strong>Focus:</strong> Negotiating priorities with AI</p>
                        <p><strong>Next:</strong> Develop revision strategy</p>
                    </div>

                    <div id="tutor-feedback" class="mb-4">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div id="tutor-messages" class="text-sm text-blue-800 dark:text-blue-300">
                                <div class="text-center text-gray-500 dark:text-gray-400 text-xs py-4">
                                    AI tutor feedback will appear here based on your progress.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="chat-messages" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4 overflow-y-auto" style="height: 300px;">
                        <div class="text-center text-gray-500 dark:text-gray-400 text-sm py-8">
                            <div class="mb-4">
                                <span class="text-2xl">üéØ</span>
                            </div>
                            <p class="mb-2 font-medium">Ready to explore your goals?</p>
                            <p class="text-xs">Ask the AI about:</p>
                            <ul class="text-xs mt-2 space-y-1 text-left">
                                <li>‚Ä¢ Which goals are most important?</li>
                                <li>‚Ä¢ How to prioritize with limited time?</li>
                                <li>‚Ä¢ What makes a strong thesis statement?</li>
                                <li>‚Ä¢ How to improve topic sentences?</li>
                            </ul>
                        </div>
                    </div>

                    <div id="loading-indicator" class="hidden text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        <p class="mt-2 text-xs text-gray-600 dark:text-gray-400">AI is thinking...</p>
                    </div>

                    <!-- Quick Action Buttons -->
                    <div class="mb-4">
                        <p class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Quick questions:</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="quick-question-btn text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-3 rounded-lg transition-colors" data-question="What should I focus on first?">
                                Focus priorities
                            </button>
                            <button class="quick-question-btn text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-3 rounded-lg transition-colors" data-question="How do I improve my thesis statement?">
                                Thesis help
                            </button>
                            <button class="quick-question-btn text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-3 rounded-lg transition-colors" data-question="What makes good topic sentences?">
                                Topic sentences
                            </button>
                            <button class="quick-question-btn text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-3 rounded-lg transition-colors" data-question="How much can I accomplish in 20 minutes?">
                                Time planning
                            </button>
                        </div>
                    </div>

                    <!-- General Chat Input -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <textarea id="general-chat-input" rows="3" placeholder="Ask the AI about goal setting, priorities, or revision strategy..." class="w-full p-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary mb-2"></textarea>
                        <button id="send-general-chat" class="w-full bg-primary hover:bg-primary-hover text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            Send Message
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.add(event.matches ? 'dark' : '');
            !event.matches && document.documentElement.classList.remove('dark');
        });

        // State
        const state = {
            selectedGoals: [],
            timeConstraint: '20min',
            strategicPlanningProgress: {
                prioritize: false,
                negotiate: false,
                constraints: false,
                strategy: false
            }
        };

        // Progress tracking functions
        function updateProgress(step) {
            state.strategicPlanningProgress[step] = true;
            const indicator = document.getElementById(`progress-${step}`);
            if (indicator) {
                indicator.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                indicator.classList.add('bg-green-500');
            }
            
            // Show immediate progress feedback
            showProgressFeedback(step);
            
            // Update AI tutor feedback based on progress
            setTimeout(() => {
                updateTutorFeedbackBasedOnProgress();
            }, 2000);
        }

        // Immediate progress feedback
        function showProgressFeedback(step) {
            const stepNames = {
                'prioritize': 'Setting Priorities',
                'negotiate': 'Negotiating Goals',
                'constraints': 'Considering Constraints',
                'strategy': 'Developing Strategy'
            };
            
            const stepName = stepNames[step] || step;
            const completedSteps = Object.values(state.strategicPlanningProgress).filter(Boolean).length;
            
            let feedback = '';
            if (completedSteps === 1) {
                feedback = `üéâ Great start! You've demonstrated ${stepName} - that's exactly what strategic planning looks like!`;
            } else if (completedSteps === 2) {
                feedback = `üéâ Excellent! You're building strong strategic planning skills with ${stepName}. Keep it up!`;
            } else if (completedSteps === 3) {
                feedback = `üéâ Outstanding! You're almost there with ${stepName}. One more skill to go!`;
            } else if (completedSteps === 4) {
                feedback = `üéâ PERFECT! You've mastered all strategic planning skills including ${stepName}!`;
            }
            
            if (feedback) {
                addTutorComment(feedback, 'progress');
            }
        }

        // Real-time AI tutor feedback based on progress
        function updateTutorFeedbackBasedOnProgress() {
            const { prioritize, negotiate, constraints, strategy } = state.strategicPlanningProgress;
            const completedSteps = [prioritize, negotiate, constraints, strategy].filter(Boolean).length;
            
            let progressComment = '';
            
            if (completedSteps === 0) {
                progressComment = `**üéØ AI Tutor Progress Update**

Welcome! I'm here to help you develop strategic planning skills while setting your revision goals.

**Current Status:** You're just getting started - that's perfect! 

**What I'm looking for:**
- Setting clear priorities (essential vs. flexible goals)
- Negotiating with AI about your goals
- Considering time constraints and limitations
- Developing a strategic revision plan

**Next Step:** Start by selecting your priority goals. I'll help you think strategically about your revision plan!`;
            } else if (completedSteps === 1) {
                progressComment = `**üéØ AI Tutor Progress Update**

Great start! You've begun engaging strategically with goal setting.

**Current Status:** 1/4 strategic planning skills demonstrated ‚úÖ

**What you've done well:**
- Started setting priorities or negotiating goals

**What I'm looking for next:**
- Continue negotiating with AI about your goals
- Consider time constraints and limitations
- Develop a strategic revision plan

**Next Step:** Keep working on your goals! Ask me "How should I prioritize these goals?" or "What constraints should I consider?"`;
            } else if (completedSteps === 2) {
                progressComment = `**üéØ AI Tutor Progress Update**

Excellent progress! You're developing strong strategic planning skills.

**Current Status:** 2/4 strategic planning skills demonstrated ‚úÖ‚úÖ

**What you've done well:**
- Setting priorities and negotiating goals
- Starting to consider constraints or develop strategy

**What I'm looking for next:**
- Continue considering time constraints and limitations
- Develop a strategic revision plan
- Negotiate with AI about your approach

**Next Step:** Try asking "What constraints should I consider?" or "How can I develop a strategic plan?"`;
            } else if (completedSteps === 3) {
                progressComment = `**üéØ AI Tutor Progress Update**

Outstanding! You're demonstrating sophisticated strategic planning.

**Current Status:** 3/4 strategic planning skills demonstrated ‚úÖ‚úÖ‚úÖ

**What you've done well:**
- Setting priorities and negotiating goals
- Considering constraints
- Developing strategic thinking

**What I'm looking for next:**
- One more skill to demonstrate complete strategic planning
- Continue developing your revision strategy
- Finalize your strategic approach

**Next Step:** You're almost there! Keep developing your strategic plan - you're doing exactly what Goal 2 requires!`;
            } else if (completedSteps === 4) {
                progressComment = `**üéØ AI Tutor Progress Update**

üéâ **PERFECT!** You've demonstrated all aspects of strategic planning!

**Current Status:** 4/4 strategic planning skills demonstrated ‚úÖ‚úÖ‚úÖ‚úÖ

**What you've accomplished:**
- ‚úÖ Set clear priorities
- ‚úÖ Negotiated goals with AI
- ‚úÖ Considered constraints and limitations
- ‚úÖ Developed strategic revision plan

**This is exactly what Goal 2 is about!** You're now thinking strategically and negotiating effectively with AI systems. This is the foundation of effective human-AI collaboration.

**Keep it up!** Continue applying these strategic planning skills as you work on your essay revision.`;
            }
            
            // Update the tutor feedback with progress-based comment
            if (progressComment) {
                updateTutorFeedback(progressComment);
            }
        }

        // Goals tracking
        const goalCheckboxes = document.querySelectorAll('.goal-checkbox');
        goalCheckboxes.forEach(cb => cb.addEventListener('change', updateGoals));
        document.getElementById('custom-goals').addEventListener('input', updateGoals);
        document.getElementById('time-constraint').addEventListener('change', updateGoals);

        function updateGoals() {
            const goals = [];
            goalCheckboxes.forEach(cb => {
                if (cb.checked) {
                    goals.push(cb.parentElement.querySelector('p.font-medium').textContent);
                }
            });
            const custom = document.getElementById('custom-goals').value.trim();
            if (custom) goals.push(custom);

            state.selectedGoals = goals;
            state.timeConstraint = document.getElementById('time-constraint').value;

            // Track progress - setting priorities
            if (goals.length > 0 && !state.strategicPlanningProgress.prioritize) {
                updateProgress('prioritize');
            }
            
            // Track progress - considering constraints
            if (state.timeConstraint !== '20min' && !state.strategicPlanningProgress.constraints) {
                updateProgress('constraints');
            }

            document.getElementById('goals-list').innerHTML = goals.length > 0
                ? goals.map((g, i) => `<p>${i + 1}. ${g}</p>`).join('')
                : '<p class="text-gray-500">No goals selected</p>';
        }
        updateGoals();

        // Custom modal function
        function showCustomModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border-2 border-primary">
                    <p class="text-gray-800 dark:text-gray-200 mb-4 text-base">${message}</p>
                    <button class="w-full px-4 py-2 bg-primary text-white hover:bg-primary-hover rounded-lg transition-colors font-semibold" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Goals Confirmation
        document.getElementById('confirm-goals').addEventListener('click', () => {
            if (state.selectedGoals.length === 0) {
                showCustomModal('Please select at least one goal before proceeding.');
                return;
            }

            // Show confirmation message
            showCustomModal('Excellent! You\'ve set your revision goals. The AI will now provide guidance on strategic planning and goal negotiation.');
            
            // Generate AI messages about goal negotiation
            setTimeout(() => {
                addChatMessage("AI", `Great job setting your revision goals! 

**Goal 2: Negotiate with AI on Agenda and Goals**

You've demonstrated strategic thinking by:
- Selecting priority areas for revision
- Considering time constraints (${state.timeConstraint})
- Focusing on macro-level issues first

**Strategic Planning Tips:**
- **Macro-level first**: Content, organization, thesis, topic sentences
- **Micro-level second**: Grammar, vocabulary, sentence structure
- **Time management**: Focus on high-impact improvements within your time limit

**Next Steps:**
Your goals are well-prioritized. We'll work through them systematically, starting with the most impactful changes. Ready to begin with your thesis statement?`);
            }, 1000);

            // Disable the button after confirmation
            document.getElementById('confirm-goals').disabled = true;
            document.getElementById('confirm-goals').textContent = '‚úì Goals Confirmed';
            document.getElementById('confirm-goals').classList.add('bg-gray-400', 'cursor-not-allowed');
        });

        // Quick question buttons
        document.querySelectorAll('.quick-question-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.getAttribute('data-question');
                document.getElementById('general-chat-input').value = question;
                document.getElementById('send-general-chat').click();
            });
        });

        // General chat
        document.getElementById('send-general-chat').addEventListener('click', () => {
            const msg = document.getElementById('general-chat-input').value.trim();
            if (!msg) return;
            
            // Track progress - negotiating with AI
            if (!state.strategicPlanningProgress.negotiate) {
                updateProgress('negotiate');
            }
            
            // Track progress - developing strategy
            if (msg.toLowerCase().includes('strategy') || msg.toLowerCase().includes('plan') || msg.toLowerCase().includes('approach')) {
                if (!state.strategicPlanningProgress.strategy) {
                    updateProgress('strategy');
                }
            }
            
            askAI(`@Claude-Sonnet-4.5 Student question about goal setting: "${msg}"

Provide guidance on strategic planning and goal negotiation with AI. Keep response under 5 sentences.`);
            document.getElementById('general-chat-input').value = '';
        });

        // AI Tutor Feedback System
        function updateTutorFeedback(content) {
            const tutorMessages = document.getElementById('tutor-messages');
            const placeholder = tutorMessages.querySelector('.text-center.text-gray-500');
            if (placeholder) placeholder.remove();

            tutorMessages.innerHTML = marked.parse(content);
        }

        function addTutorComment(content, type = 'analysis') {
            const tutorMessages = document.getElementById('tutor-messages');
            const placeholder = tutorMessages.querySelector('.text-center.text-gray-500');
            if (placeholder) placeholder.remove();

            const comment = document.createElement('div');
            let bgClass = 'bg-blue-50 dark:bg-blue-900/30';
            if (type === 'progress') {
                bgClass = 'bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-500';
            } else if (type === 'analysis') {
                bgClass = 'bg-blue-50 dark:bg-blue-900/30';
            } else {
                bgClass = 'bg-green-50 dark:bg-green-900/30';
            }
            
            comment.className = `mb-3 p-3 rounded-lg ${bgClass}`;
            comment.innerHTML = marked.parse(content);
            tutorMessages.appendChild(comment);
        }

        // AI Communication
        function addChatMessage(sender, content) {
            const chat = document.getElementById('chat-messages');
            const placeholder = chat.querySelector('.text-center.text-gray-500');
            if (placeholder) placeholder.remove();

            const msg = document.createElement('div');
            msg.className = 'mb-3';
            msg.innerHTML = `
                <div class="text-xs font-semibold mb-1 ${sender === 'You' ? 'text-gray-600 dark:text-gray-400' : 'text-primary'}">${sender === 'You' ? 'üë§' : 'ü§ñ'} ${sender}</div>
                <div class="p-3 rounded-lg text-sm ${sender === 'You' ? 'bg-gray-200 dark:bg-gray-600' : 'bg-blue-50 dark:bg-blue-900/30'}">${marked.parse(content)}</div>
            `;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateLastAIMessage(content) {
            const chat = document.getElementById('chat-messages');
            const messages = chat.querySelectorAll('.mb-3');
            if (messages.length > 0) {
                const last = messages[messages.length - 1];
                const contentDiv = last.querySelector('.p-3');
                if (contentDiv) {
                    contentDiv.innerHTML = marked.parse(content);
                    chat.scrollTop = chat.scrollHeight;
                }
            }
        }

        if (window.Poe) {
            window.Poe.registerHandler("essay-training", (result) => {
                const msg = result.responses[0];
                document.getElementById('loading-indicator').classList.add('hidden');

                if (msg.status === "error") {
                    addChatMessage("AI", `Error: ${msg.statusText}`);
                } else if (msg.status === "incomplete") {
                    if (msg.content.trim()) {
                        updateLastAIMessage(msg.content);
                    }
                } else if (msg.status === "complete") {
                    updateLastAIMessage(msg.content);
                }
            });
        }

        async function askAI(prompt) {
            if (!window.Poe) {
                showCustomModal("Poe API not available. This app needs to run in the Poe environment.");
                return;
            }

            // Extract user message from prompt
            const userMsg = prompt.split('\n').slice(1).join('\n').substring(0, 100) + '...';
            addChatMessage("You", userMsg);
            addChatMessage("AI", "...");
            document.getElementById('loading-indicator').classList.remove('hidden');

            try {
                await window.Poe.sendUserMessage(prompt, {
                    handler: "essay-training",
                    stream: true,
                    openChat: false
                });
            } catch (err) {
                document.getElementById('loading-indicator').classList.add('hidden');
                addChatMessage("AI", `Error: ${err.message}`);
            }
        }

        // Initialize with progress-based feedback
        updateTutorFeedbackBasedOnProgress();
        
        console.log('Goal Setting tab loaded');
    </script>
</body>
</html>
